name: embodied-claude-test

services:
  postgres:
    build:
      context: ./postgres
      dockerfile: Dockerfile
    container_name: embodied-claude-test-db
    ports:
      - "0:5432"  # auto-assign host port
    environment:
      POSTGRES_DB: embodied_claude
      POSTGRES_USER: memory_mcp
      POSTGRES_PASSWORD: test_ci_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=ja_JP.UTF-8"
    volumes:
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    command: >
      postgres
        -c shared_preload_libraries=''
        -c shared_buffers=128MB
        -c effective_cache_size=256MB
        -c work_mem=32MB
        -c maintenance_work_mem=64MB
        -c max_connections=10
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U memory_mcp -d embodied_claude_test"]
      interval: 5s
      timeout: 3s
      retries: 10
    shm_size: 128mb

  embedding-api:
    build:
      context: ./embedding-api
      dockerfile: Dockerfile
    container_name: embodied-claude-test-embedding
    ports:
      - "0:8100"  # auto-assign host port
    environment:
      MODEL_NAME: intfloat/multilingual-e5-base
      MAX_BATCH_SIZE: 64
    volumes:
      - model-cache:/root/.cache/huggingface
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8100/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

volumes:
  model-cache:
    name: embodied-claude-model-cache  # share with dev
